name: Build Artifacts

on:
  push:
    branches:
      - main

jobs:
  build-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Install Yarn
      run: npm install -g yarn

    - name: Install Newman
      run: npm install -g newman

    - name: Run backend tests
      working-directory: ./backend
      run: |
        docker-compose -f ../docker-compose-ci.yml up --build -d
        sleep 5
        newman run postman/Intensivao-Devops.postman_collection.json
      
    - name: Generate Backend Semantic Version
      id: backend_version
      run: echo "::set-output name=version::1.0.${{ github.run_number }}"

    - name: Build and Push Docker Image
      run: |
        version=$(echo "${{ steps.backend_version.outputs.version }}")
        docker build -t brenno/app:${version} -t brenno/app:latest -f ./backend/Dockerfile .
        docker tag brenno/app ${{ secrets.ACR_SERVER }}/${{ secrets.IMAGE_NAME }}:${version}
        docker tag brenno/app ${{ secrets.ACR_SERVER }}/${{ secrets.IMAGE_NAME }}:latest
        docker login ${{ secrets.ACR_SERVER }} -u ${{ secrets.ACR_USERNAME }} -p ${{ secrets.ACR_PASSWORD }}
        docker push ${{ secrets.ACR_SERVER }}/${{ secrets.IMAGE_NAME }}:${version}
        docker push ${{ secrets.ACR_SERVER }}/${{ secrets.IMAGE_NAME }}:latest

    - name: Save run number to file
      run: echo "${{ github.run_number }}" > run_number.txt

    - name: Archive run number
      if: always()
      uses: actions/upload-artifact@v2
      with:
        name: run_number
        path: run_number.txt
        if-no-files-found: error

  build-frontend:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20.8.1'

      - name: Install frontend dependencies
        run: yarn --cwd frontend install

      - name: Run frontend tests
        working-directory: ./frontend
        run: yarn test --passWithNoTests

      - name: Generate Frontend Semantic Version
        id: frontend_version
        run: echo "::set-output name=version::1.0.${{ github.run_number }}"

      - name: Build frontend
        run: |
          version=$(echo "${{ steps.frontend_version.outputs.version }}")
          yarn --cwd frontend build:deploy --version=${version}

      - name: Upload artifact to GitHub Packages
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build
